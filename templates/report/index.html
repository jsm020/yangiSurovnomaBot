<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talabalarni Baholash</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'style.css' %}" />
  <style>
    .filters { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
    .stats { margin-top: 10px; }
    .hidden { display: none; }
    select, input[type="text"], button { padding: 5px; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    .student-header { cursor: pointer; padding: 10px; background: #f9f9f9; }
    .student-details { padding: 10px; }
    .results-table { margin-bottom: 20px; }
    .fully-evaluated { background: #e0f7e0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Talabalarni Baholash</h1>
    <form method="post" action="" id="filterForm">
      {% csrf_token %}
      <div class="filters">
        {{ form.search }}
        {{ form.faculty }}
        {{ form.course }}
        {{ form.group }}
        <button type="submit" id="submitFilters">üîç Filtrlash</button>
        <button type="button" id="exportExcel">üìÅ Excelga eksport</button>
      </div>
      {% if messages %}
        {% for message in messages %}
          <p style="color: red;">{{ message }}</p>
        {% endfor %}
      {% endif %}
    </form>
    <div id="groupStats" class="stats hidden"></div>
    <div id="studentList"></div>
  </div>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    let GOOD_REASONS = {};
    let WEAK_REASONS = {};
    const studentsRawData = [];
    let filteredStudents = [];

    const form = document.getElementById('filterForm');
    const searchInput = document.getElementById('id_search');
    const facultySelect = document.getElementById('id_faculty');
    const courseSelect = document.getElementById('id_course');
    const groupSelect = document.getElementById('id_group');
    const studentList = document.getElementById('studentList');
    const groupStats = document.getElementById('groupStats');
    const submitFilters = document.getElementById('submitFilters');
    const exportExcel = document.getElementById('exportExcel');

    // Sabablarni yuklash funksiyasi
    async function fetchReasons() {
      try {
        const [goodReasonsResponse, weakReasonsResponse] = await Promise.all([
          fetch('/api/students/good_reasons/'),
          fetch('/api/students/weak_reasons/')
        ]);

        console.log('Good reasons status:', goodReasonsResponse.status);
        console.log('Good reasons headers:', goodReasonsResponse.headers.get('content-type'));
        console.log('Weak reasons status:', weakReasonsResponse.status);
        console.log('Weak reasons headers:', weakReasonsResponse.headers.get('content-type'));

        if (!goodReasonsResponse.ok || !weakReasonsResponse.ok) {
          const [goodText, weakText] = await Promise.all([
            goodReasonsResponse.text(),
            weakReasonsResponse.text()
          ]);
          throw new Error(
            `Good reasons failed: ${goodReasonsResponse.status} - ${goodText}; ` +
            `Weak reasons failed: ${weakReasonsResponse.status} - ${weakText}`
          );
        }

        GOOD_REASONS = await goodReasonsResponse.json();
        WEAK_REASONS = await weakReasonsResponse.json();
      } catch (error) {
        console.error("Error fetching reasons:", error);
      }
    }

    // Fakultet va kurs bo‚Äòyicha kurslar va guruhlar ro‚Äòyxatini yangilash
    async function updateFilterOptions(faculty, course = '') {
      try {
        const params = new URLSearchParams();
        if (faculty) params.append('faculty', faculty);
        if (course) params.append('course', course);

        const response = await fetch(`/api/students/filter-options/?${params.toString()}`);
        console.log('Filter options status:', response.status);
        console.log('Filter options headers:', response.headers.get('content-type'));

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Filter options fetch failed: ${response.status} - ${errorText}`);
        }

        const data = await response.json();

        // Kurslarni yangilash (faqat fakultet o‚Äòzgarganda)
        if (!course) {
          courseSelect.innerHTML = '<option value="">üìò Kurs</option>';
          data.courses.forEach(course => {
            courseSelect.add(new Option(course, course));
          });
        }

        // Guruhlarni yangilash
        groupSelect.innerHTML = '<option value="">üë• Guruh</option>';
        data.groups.forEach(group => {
          groupSelect.add(new Option(group, group));
        });
      } catch (error) {
        console.error("Error fetching filter options:", error);
      }
    }

    // Talabalar ro‚Äòyxatini yuklash
    async function fetchStudents() {
      try {
        const params = new URLSearchParams();
        if (searchInput.value) params.append('search', searchInput.value);
        if (facultySelect.value) params.append('faculty', facultySelect.value);
        if (courseSelect.value) params.append('course', courseSelect.value);
        if (groupSelect.value) params.append('group', groupSelect.value);

        const response = await fetch(`/api/students/list/?${params.toString()}`, {
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
        });

        console.log('Students API status:', response.status);
        console.log('Students API headers:', response.headers.get('content-type'));

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Students fetch failed: ${response.status} - ${errorText}`);
        }

        const studentsData = await response.json();
        console.log("Fetched Students:", studentsData);

        studentsRawData.length = 0;
        studentsData.forEach(row => {
          if (!row.faculty || !row.course || !row.group || !row.full_name) return;
          studentsRawData.push({
            faculty: row.faculty,
            course: row.course.toString(),
            group: row.group,
            name: row.full_name,
            evaluated: row.evaluated || false,
            votes: row.votes || {},
            excellent_votes: row.excellent_votes || 0,
            atrisk_votes: row.atrisk_votes || 0
          });
        });
      } catch (error) {
        console.error("Error fetching students:", error);
        studentList.innerHTML = `<p>‚ùå Talabalarni yuklashda xatolik yuz berdi: ${error.message}</p>`;
      }
    }

    // Talabalar ro‚Äòyxatini ko‚Äòrsatish
    function renderStudents() {
      groupStats.className = 'stats hidden';
      studentList.innerHTML = '';

      const selectedGroup = groupSelect.value;
      filteredStudents = studentsRawData;

      if (filteredStudents.length === 0) {
        studentList.innerHTML = '<p>‚ùå Hech qanday talaba topilmadi.</p>';
        return;
      }

      // Guruh statistikasini hisoblash
      if (selectedGroup) {
        const groupStudents = studentsRawData.filter(s => s.group === selectedGroup);
        const participated = groupStudents.filter(s => s.evaluated).length;
        const percent = groupStudents.length ? ((participated / groupStudents.length) * 100).toFixed(1) : 0;
        groupStats.innerHTML = `<p><strong>Guruh ishtiroki:</strong> ${percent}% (${participated}/${groupStudents.length})</p>`;
        groupStats.className = 'stats';
      }

      // Har bir talaba uchun HTML yaratish
      filteredStudents.forEach((student, index) => {
        // –ü–æ–¥—Å—á—ë—Ç –≥–æ–ª–æ—Å–æ–≤ –∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö
        const goodKeys = Object.keys(GOOD_REASONS);
        const weakKeys = Object.keys(WEAK_REASONS);

        // –°—É–º–º–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
        const excellentTotal = goodKeys.reduce((sum, key) => sum + (student.votes[key] || 0), 0);
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞
        const excellentVoters = goodKeys.some(key => (student.votes[key] || 0) > 0) ? 1 : 0;
        // –°—É–º–º–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
        const atriskTotal = weakKeys.reduce((sum, key) => sum + (student.votes[key] || 0), 0);
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –∑–∞ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
        const atriskVoters = weakKeys.some(key => (student.votes[key] || 0) > 0) ? 1 : 0;

        const div = document.createElement('div');
        div.className = 'student';
        div.innerHTML = `
          <div class="student-header" data-index="${index}">
            ${student.name} ${student.evaluated ? '‚úÖ' : ''}
            <span class="votes-count">
              (üëç ${excellentTotal} | üëé ${atriskTotal} (üë§${excellentVoters}|üë§${atriskVoters}))
            </span>
          </div>
          <div class="student-details hidden" id="student-${index}"></div>
        `;
        
        if (student.evaluated) {
          div.querySelector('.student-header').classList.add('fully-evaluated');
        }
        
        studentList.appendChild(div);
      });

      // Talabalar detallarini yuklash
      document.querySelectorAll('.student-header').forEach(header => {
        header.onclick = async () => {
          const index = header.getAttribute('data-index');
          const box = document.getElementById(`student-${index}`);
          const student = filteredStudents[index];
          
          header.classList.toggle('opened');
          box.classList.toggle('hidden');

          // Agar sabablar yuklanmagan bo‚Äòlsa, yuklab olamiz
          if (!Object.keys(GOOD_REASONS).length || !Object.keys(WEAK_REASONS).length) {
            await fetchReasons();
          }

          const groupStudents = studentsRawData.filter(s => s.group === student.group);
          const goodKeys = Object.keys(GOOD_REASONS);
          const weakKeys = Object.keys(WEAK_REASONS);

          // Ovozlarni hisoblash
          let goodVotes = 0;
          let weakVotes = 0;
          for (const key of Object.keys(student.votes)) {
            if (goodKeys.includes(key)) goodVotes += student.votes[key];
            if (weakKeys.includes(key)) weakVotes += student.votes[key];
          }

          const totalInGroup = groupStudents.length;
          const goodPercent = totalInGroup ? Math.min(((goodVotes / totalInGroup) * 100).toFixed(1), 100) : 0;
          const weakPercent = totalInGroup ? Math.min(((weakVotes / totalInGroup) * 100).toFixed(1), 100) : 0;

          // Jadval qatorini yaratish funksiyasi
          const createRow = (data, allKeys) =>
            `<tr>${allKeys.map(key => `<td>${data[key] || 0}</td>`).join('')}</tr>`;

          // HTML generatsiya qilish
          box.innerHTML = `
            <div class="results-table">
              <h4>‚úÖ Yaxshi xususiyatlar</h4>
              <p><strong>Boshqalar tomonidan tanlangan:</strong> ${goodPercent}% (${goodVotes}/${totalInGroup})</p>
              <table>
                <tr>${goodKeys.map(k => `<th>${GOOD_REASONS[k]}</th>`).join('')}</tr>
                ${createRow(student.votes, goodKeys)}
              </table>
            </div>
            <div class="results-table">
              <h4>‚ö†Ô∏è Kuchsiz tomonlar</h4>
              <p><strong>Boshqalar tomonidan tanlangan:</strong> ${weakPercent}% (${weakVotes}/${totalInGroup})</p>
              <table>
                <tr>${weakKeys.map(k => `<th>${WEAK_REASONS[k]}</th>`).join('')}</tr>
                ${createRow(student.votes, weakKeys)}
              </table>
            </div>
          `;
        };
      });
    }

    // Excelga eksport qilish funksiyasi
    exportExcel.onclick = () => {
      if (filteredStudents.length === 0) {
        alert('‚ùå Avval filtrlab talabalarni tanlang.');
        return;
      }

      const goodKeys = Object.keys(GOOD_REASONS);
      const weakKeys = Object.keys(WEAK_REASONS);

      // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
      const headers = [
        [
          '‚Ññ', 'Fakultet', 'Kurs', 'Guruh', 'F.I.O.',
          'Yaxshi xususiyatlar', ...Array(goodKeys.length - 1).fill(''), '',
          'Kuchsiz tomonlar', ...Array(weakKeys.length - 1).fill(''), ''
        ],
        [
          '', '', '', '', '',
          ...goodKeys.map(key => GOOD_REASONS[key]), 'Jami ovozlar',
          ...weakKeys.map(key => WEAK_REASONS[key]), 'Jami ovozlar'
        ]
      ];

      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
      const data = filteredStudents.map((student, index) => {
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –∫—Ç–æ-—Ç–æ –∑–∞ —Ö–æ—Ä–æ—à–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ (1 –∏–ª–∏ 0)
        const goodVoters = goodKeys.some(key => (student.votes[key] || 0) > 0) ? 1 : 0;
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –∫—Ç–æ-—Ç–æ –∑–∞ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (1 –∏–ª–∏ 0)
        const weakVoters = weakKeys.some(key => (student.votes[key] || 0) > 0) ? 1 : 0;
        return [
          index + 1,
          student.faculty,
          student.course,
          student.group,
          student.name,
          ...goodKeys.map(key => student.votes[key] || 0),
          goodVoters,
          ...weakKeys.map(key => student.votes[key] || 0),
          weakVoters
        ];
      });

      // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ
      const sheetData = [...headers, ...data];

      // –°–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç
      const worksheet = XLSX.utils.aoa_to_sheet(sheetData);

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —è—á–µ–µ–∫, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
      worksheet['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 1, c: 0 } }, // ‚Ññ (A1:A2)
        { s: { r: 0, c: 1 }, e: { r: 1, c: 1 } }, // Fakultet (B1:B2)
        { s: { r: 0, c: 2 }, e: { r: 1, c: 2 } }, // Kurs (C1:C2)
        { s: { r: 0, c: 3 }, e: { r: 1, c: 3 } }, // Guruh (D1:D2)
        { s: { r: 0, c: 4 }, e: { r: 1, c: 4 } }, // F.I.O. (E1:E2)
        { s: { r: 0, c: 5 }, e: { r: 0, c: 5 + goodKeys.length } }, // Yaxshi xususiyatlar
        { s: { r: 0, c: 6 + goodKeys.length }, e: { r: 0, c: 6 + goodKeys.length + weakKeys.length } } // Kuchsiz tomonlar
      ];

      // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ (—É–≤–µ–ª–∏—á–µ–Ω—ã –¥–ª—è –∫–∞—á–µ—Å—Ç–≤ –∏ Jami ovozlar)
      const minColWidths = [
        { wch: 5 }, // ‚Ññ
        { wch: 20 }, // Fakultet
        { wch: 10 }, // Kurs
        { wch: 10 }, // Guruh
        { wch: 30 }, // F.I.O.
        ...goodKeys.map(() => ({ wch: 20 })), // Yaxshi xususiyatlar
        { wch: 20 }, // Jami ovozlar (—Ö–æ—Ä–æ—à–∏–µ)
        ...weakKeys.map(() => ({ wch: 20 })), // Kuchsiz tomonlar
        { wch: 20 } // Jami ovozlar (—Å–ª–∞–±—ã–µ)
      ];

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
      const colWidths = [];
      sheetData.forEach(row => {
        row.forEach((cell, colIndex) => {
          const cellValue = cell ? cell.toString() : '';
          const cellLength = cellValue.length * 1.2; // –£—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
          colWidths[colIndex] = Math.max(colWidths[colIndex] || 0, cellLength);
        });
      });

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤ —Å —É—á—ë—Ç–æ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
      worksheet['!cols'] = colWidths.map((width, i) => ({
        wch: Math.max(minColWidths[i].wch, width + 4) // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø
      }));

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∏—Ä–∏–Ω —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('Column Widths:', worksheet['!cols'].map(col => col.wch));

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ —è—á–µ–π–∫–∞–º
      const range = XLSX.utils.decode_range(worksheet['!ref']);
      for (let row = range.s.r; row <= range.e.r; row++) {
        for (let col = range.s.c; col <= range.e.c; col++) {
          const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });

          // –°–æ–∑–¥–∞—ë–º —è—á–µ–π–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if (!worksheet[cellAddress]) {
            worksheet[cellAddress] = { t: 's', v: '' };
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏
          const isFaculty = col === 1; // Fakultet (B)
          const isFIO = col === 4; // F.I.O. (E)
          const isHeader = row < 2; // –ü–µ—Ä–≤—ã–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
          const isNumberColumn = col === 0; // –°—Ç–æ–ª–±–µ—Ü ‚Ññ (A)

          worksheet[cellAddress].s = {
            alignment: {
              halign: isFaculty || isFIO ? 'right' : 'center',
              valign: 'center',
              wrapText: true
            },
            border: {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            }
          };

          // –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Å—Ç–æ–ª–±—Ü–∞ ‚Ññ
          if (isHeader || isNumberColumn) {
            worksheet[cellAddress].s.font = { bold: true };
          }

          // –°–≤–µ—Ç–ª–æ-—Å–µ—Ä–∞—è –∑–∞–ª–∏–≤–∫–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
          if (isHeader) {
            worksheet[cellAddress].s.fill = {
              patternType: 'solid',
              fgColor: { rgb: 'D3D3D3' }
            };
          }
        }
      }

      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∏–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('Sample Cell Style (A1):', worksheet['A1']?.s);
      console.log('Sample Cell Style (B3):', worksheet['B3']?.s);
      console.log('Sample Cell Style (C3):', worksheet['C3']?.s);

      // –°–æ–∑–¥–∞—ë–º –∫–Ω–∏–≥—É –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Talabalar');
      XLSX.writeFile(workbook, `talabalar_statistikasi_${new Date().toISOString().slice(0, 10)}.xlsx`);
    };

    // Fakultet tanlanganda kurslar va guruhlar ro‚Äòyxatini yangilash
    facultySelect.onchange = () => {
      updateFilterOptions(facultySelect.value);
      fetchStudents().then(() => renderStudents());
    };

    // Kurs tanlanganda guruhlar ro‚Äòyxatini yangilash
    courseSelect.onchange = () => {
      updateFilterOptions(facultySelect.value, courseSelect.value);
      fetchStudents().then(() => renderStudents());
    };

    // Guruh tanlanganda talabalar ro‚Äòyxatini yangilash
    groupSelect.onchange = () => {
      fetchStudents().then(() => renderStudents());
    };

    // Qidiruv maydoniga matn kiritilganda talabalar ro‚Äòyxatini yangilash
    searchInput.oninput = () => {
      fetchStudents().then(() => renderStudents());
    };

    // Forma yuborilganda sahifani qayta yuklamaslik uchun
    form.onsubmit = async (e) => {
      e.preventDefault();
      await fetchStudents();
      renderStudents();
    };

    // Sahifa yuklanganda boshlang‚Äòich ma'lumotlarni olish
    window.onload = async () => {
      await fetchReasons();
      await fetchStudents();
      await updateFilterOptions(''); // Boshlang‚Äòich kurslar va guruhlar ro‚Äòyxatini yuklash
      renderStudents();
    };
  </script>
</body>
</html>